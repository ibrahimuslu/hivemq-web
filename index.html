<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GARAJ ANAHTARI</title>
  <!-- Include Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <style>
    /* Ensure the page takes up the entire viewport and prevents scrolling */
    html, body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #1a1a1a;
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Container to fill full width and height */
    .container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    /* Control panel centered within container */
    .control-panel {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }

    /* Button styles with arrows and color transition */
    .btn-toggle {
      width: 100%;
      padding: 30px;
      font-size: 2em;
      margin-bottom: 20px;
      max-width: 400px; /* Limit max width for larger screens */
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.3s;
    }

    .btn-toggle.up .arrow {
      font-size: 1.5em;
      margin-bottom: 10px;
      color: white;
    }

    .btn-toggle.down .arrow {
      font-size: 1.5em;
      margin-top: 10px;
      color: white;
    }

    .btn-toggle.up .arrow.pressed {
      color: #28a745; /* Green color when pressed */
    }
    .btn-toggle.down .arrow.pressed {
      color: #28a745; /* Green color when pressed */
    }
    /* Status indicator styling */
    .status-indicator {
      font-size: 1.2em;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      max-width: 400px;
      width: 100%;
      text-align: center;
    }

    .status-connected {
      background-color: #28a745;
    }

    .status-disconnected {
      background-color: #dc3545;
    }

    .status-unknown {
      background-color: #6c757d;
    }

    /* Hide the MQTT config form initially */
    #mqttConfigForm {
      display: none;
      margin-top: 30px;
      padding: 20px;
      border-radius: 10px;
      background-color: #333;
      text-align: left;
      width: 90%;
      max-width: 400px;
    }
  </style>
</head>
<body>

  <div class="container control-panel">
    <h1 class="text-center">GARAJ ANAHTARI</h1>

    <!-- MQTT Configuration Form -->
    <div id="mqttConfigForm">
      <h2 class="text-center">MQTT Configuration</h2>
      <form id="configForm">
        <div class="form-group">
          <label for="mqttUrl">MQTT URL</label>
          <input type="text" class="form-control" id="mqttUrl" placeholder="Enter MQTT broker URL">
        </div>
        <div class="form-group">
          <label for="mqttUsername">Username</label>
          <input type="text" class="form-control" id="mqttUsername" placeholder="Enter Username">
        </div>
        <div class="form-group">
          <label for="mqttPassword">Password</label>
          <input type="password" class="form-control" id="mqttPassword" placeholder="Enter Password">
        </div>
        <button type="submit" class="btn btn-primary">Save and Connect</button>
      </form>
    </div>

    <div class="row justify-content-center" id="controlPanel" style="display:none; width: 100%;">
      <div>
        <!-- Status Indicator -->
        <div id="statusIndicator" class="status-indicator text-center status-unknown">
          GARAJ KAPISI: UNKNOWN
        </div>
        <!-- Up and Down Buttons with Arrows -->
        <button id="upButton" class="btn btn-primary btn-toggle up" disabled>
          <span class="arrow">&#9650;</span> <!-- Up arrow -->
          <span>Up</span>
        </button>
        <button id="downButton" class="btn btn-primary btn-toggle down" disabled>
          <span>Down</span>
          <span class="arrow">&#9660;</span> <!-- Down arrow -->
        </button>
      </div>
    </div>
  </div>

  <!-- Include Paho MQTT JavaScript client -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
  <!-- Include Bootstrap JS and dependencies -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    const upButton = document.getElementById("upButton");
    const downButton = document.getElementById("downButton");
    const statusIndicator = document.getElementById("statusIndicator");
    const mqttConfigForm = document.getElementById("mqttConfigForm");
    const controlPanel = document.getElementById("controlPanel");

    const brokerUrl = localStorage.getItem("mqttUrl");
    const username = localStorage.getItem("mqttUsername");
    const password = localStorage.getItem("mqttPassword");

    if (!brokerUrl || !username || !password) {
      mqttConfigForm.style.display = 'block';
    } else {
      startMqttClient(brokerUrl, username, password);
      controlPanel.style.display = 'flex';
    }

    document.getElementById("configForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const url = document.getElementById("mqttUrl").value;
      const user = document.getElementById("mqttUsername").value;
      const pass = document.getElementById("mqttPassword").value;

      localStorage.setItem("mqttUrl", url);
      localStorage.setItem("mqttUsername", user);
      localStorage.setItem("mqttPassword", pass);

      mqttConfigForm.style.display = 'none';
      controlPanel.style.display = 'block';
      startMqttClient(url, user, pass);
    });

    function startMqttClient(brokerUrl, username, password) {
      const port = 8884;
      const clientId = "WebClient_" + Math.random().toString(16).substr(2, 8);
      const client = new Paho.MQTT.Client(brokerUrl, port, clientId);
      client.status = ""
      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;

      const options = {
        timeout: 3,
        useSSL: true,
        userName: username,
        password: password,
        onSuccess: onConnect,
        onFailure: onFailure
      };

      client.connect(options);

      function onConnect() {
        console.log("Connected to MQTT broker");
        client.subscribe("device/status");
      }

      function onFailure(responseObject) {
        console.log("Connection failed: " + responseObject.errorMessage);
      }

      function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
          console.log("Connection lost: " + responseObject.errorMessage);
          client.connect(options);
        }
      }

      function onMessageArrived(message) {
        if (message.destinationName === "device/status") {
          updateStatusIndicator(message.payloadString);
        }
      }

      function updateStatusIndicator(status) {
        client.status = status
        statusIndicator.classList.remove("status-connected", "status-disconnected", "status-unknown");

        if (status === "connected") {
          statusIndicator.textContent = "GARAJ KAPISI: CONNECTED";
          statusIndicator.classList.add("status-connected");
          upButton.disabled = false;
          downButton.disabled = false;
        } else if (status === "disconnected") {
          statusIndicator.textContent = "GARAJ KAPISI: DISCONNECTED";
          statusIndicator.classList.add("status-disconnected");
          upButton.disabled = true;
          downButton.disabled = true;
        } else {
          statusIndicator.textContent = "GARAJ KAPISI: UNKNOWN";
          statusIndicator.classList.add("status-unknown");
          upButton.disabled = true;
          downButton.disabled = true;
        }
      }

      function sendMessage(topic, message) {
        const mqttMessage = new Paho.MQTT.Message(message);
        mqttMessage.destinationName = topic;
        client.send(mqttMessage);
      }

      function addButtonListeners(button, topic) {
        button.addEventListener("mousedown", () => {
          sendMessage(topic, "1");
          toggleButtonState(button, true);
        });
        button.addEventListener("mouseup", () => {
          sendMessage(topic, "0");
          toggleButtonState(button, false);
        });
        button.addEventListener("touchstart", (e) => {
          e.preventDefault();
          sendMessage(topic, "1");
          toggleButtonState(button, true);
        });
        button.addEventListener("touchend", (e) => {
          e.preventDefault();
          sendMessage(topic, "0");
          toggleButtonState(button, false);
        });
      }

      function toggleButtonState(button, isPressed) {
        if (isPressed) {

          if(client.status == "connected"){
            button.getElementsByTagName("span")[0].classList.add("pressed");
            button.getElementsByTagName("span")[1].classList.add("pressed");
          }
          if (button === upButton) downButton.disabled = true;
          if (button === downButton) upButton.disabled = true;
        } else {
          button.getElementsByTagName("span")[0].classList.remove("pressed");
          button.getElementsByTagName("span")[1].classList.remove("pressed");
          if(client.status == "connected"){
            downButton.disabled = false;
            upButton.disabled = false;
          }
        }
      }

      addButtonListeners(upButton, "device/gpio/18");
      addButtonListeners(downButton, "device/gpio/10");

      window.addEventListener("beforeunload", function () {
        if (client.isConnected()) {
          client.disconnect();
        }
      });
    }
  </script>

</body>
</html>
