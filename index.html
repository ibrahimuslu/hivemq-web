<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GARAJ ANAHTARI</title>
  <!-- Include Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #1a1a1a;
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      height: 100%;
    }

    .control-panel {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .btn-toggle {
      width: 200px;
      padding: 20px;
      font-size: 2em;
      margin-bottom: 20px;
    }

    .status-indicator {
      font-size: 1.2em;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .status-connected {
      background-color: #28a745;
    }

    .status-disconnected {
      background-color: #dc3545;
    }

    .status-unknown {
      background-color: #6c757d;
    }

    #mqttConfigForm {
      display: none;
      margin-top: 30px;
      padding: 20px;
      border-radius: 10px;
      background-color: #333;
      text-align: left;
    }
  </style>
</head>
<body>

  <div class="container control-panel">
    <h1 class="text-center">GARAJ ANAHTARI</h1>

    <!-- MQTT Configuration Form -->
    <div id="mqttConfigForm">
      <h2 class="text-center">MQTT Configuration</h2>
      <form id="configForm">
        <div class="form-group">
          <label for="mqttUrl">MQTT URL</label>
          <input type="text" class="form-control" id="mqttUrl" placeholder="Enter MQTT broker URL">
        </div>
        <div class="form-group">
          <label for="mqttUsername">Username</label>
          <input type="text" class="form-control" id="mqttUsername" placeholder="Enter Username">
        </div>
        <div class="form-group">
          <label for="mqttPassword">Password</label>
          <input type="password" class="form-control" id="mqttPassword" placeholder="Enter Password">
        </div>
        <button type="submit" class="btn btn-primary">Save and Connect</button>
      </form>
    </div>

    <div class="row justify-content-center" id="controlPanel" style="display:none;">
      <div class="col-12">
        <!-- Status Indicator -->
        <div id="statusIndicator" class="status-indicator text-center status-unknown">
          GARAJ KAPISI: UNKNOWN
        </div>
        <!-- Up and Down Buttons -->
        <button id="upButton" class="btn btn-primary btn-toggle">Up</button>
        <button id="downButton" class="btn btn-secondary btn-toggle">Down</button>
      </div>
    </div>
  </div>

  <!-- Include Paho MQTT JavaScript client -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
  <!-- Include Bootstrap JS and dependencies -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    const upButton = document.getElementById("upButton");
    const downButton = document.getElementById("downButton");
    const statusIndicator = document.getElementById("statusIndicator");
    const mqttConfigForm = document.getElementById("mqttConfigForm");
    const controlPanel = document.getElementById("controlPanel");

    const brokerUrl = localStorage.getItem("mqttUrl");
    const username = localStorage.getItem("mqttUsername");
    const password = localStorage.getItem("mqttPassword");

    if (!brokerUrl || !username || !password) {
      mqttConfigForm.style.display = 'block';
    } else {
      startMqttClient(brokerUrl, username, password);
      controlPanel.style.display = 'block';
    }

    document.getElementById("configForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const url = document.getElementById("mqttUrl").value;
      const user = document.getElementById("mqttUsername").value;
      const pass = document.getElementById("mqttPassword").value;

      localStorage.setItem("mqttUrl", url);
      localStorage.setItem("mqttUsername", user);
      localStorage.setItem("mqttPassword", pass);

      mqttConfigForm.style.display = 'none';
      controlPanel.style.display = 'block';
      startMqttClient(url, user, pass);
    });

    function startMqttClient(brokerUrl, username, password) {
      const port = 8884;
      const clientId = "WebClient_" + Math.random().toString(16).substr(2, 8);
      const client = new Paho.MQTT.Client(brokerUrl, port, clientId);

      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;

      const options = {
        timeout: 3,
        useSSL: true,
        userName: username,
        password: password,
        onSuccess: onConnect,
        onFailure: onFailure
      };

      client.connect(options);

      function onConnect() {
        console.log("Connected to MQTT broker");
        client.subscribe("device/status"); // Subscribe to device status topic
      }

      function onFailure(responseObject) {
        console.log("Connection failed: " + responseObject.errorMessage);
      }

      function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
          console.log("Connection lost: " + responseObject.errorMessage);
          client.connect(options);
        }
      }

      function onMessageArrived(message) {
        console.log("Message arrived on topic " + message.destinationName + ": " + message.payloadString);

        if (message.destinationName === "device/status") {
          updateStatusIndicator(message.payloadString);
        }
      }

      function updateStatusIndicator(status) {
        statusIndicator.classList.remove("status-connected", "status-disconnected", "status-unknown");

        if (status === "connected") {
          statusIndicator.textContent = "GARAJ KAPISI: CONNECTED";
          statusIndicator.classList.add("status-connected");
        } else if (status === "disconnected") {
          statusIndicator.textContent = "GARAJ KAPISI: DISCONNECTED";
          statusIndicator.classList.add("status-disconnected");
        } else {
          statusIndicator.textContent = "GARAJ KAPISI: UNKNOWN";
          statusIndicator.classList.add("status-unknown");
        }
      }

      function sendMessage(topic, message) {
        const mqttMessage = new Paho.MQTT.Message(message);
        mqttMessage.destinationName = topic;
        client.send(mqttMessage);
        console.log(`Sent message to ${topic}: ${message}`);
      }

      upButton.addEventListener("mousedown", function () {
        sendMessage("device/gpio/18", "1");
        downButton.disabled = true;
      });

      upButton.addEventListener("mouseup", function () {
        sendMessage("device/gpio/18", "0");
        downButton.disabled = false;
      });

      downButton.addEventListener("mousedown", function () {
        sendMessage("device/gpio/10", "1");
        upButton.disabled = true;
      });

      downButton.addEventListener("mouseup", function () {
        sendMessage("device/gpio/10", "0");
        upButton.disabled = false;
      });

      window.addEventListener("beforeunload", function () {
        if (client.isConnected()) {
          client.disconnect();
        }
      });
    }
  </script>

</body>
</html>
